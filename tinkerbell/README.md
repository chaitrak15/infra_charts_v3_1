<!-- SPDX-FileCopyrightText: (C) 2025 Intel Corporation -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

# Tinkerbell Umbrella charts

## Table of Contents

- [Overview](#overview)
- [Get Started](#get-started)
- [Contribute](#contribute)
- [Community and Support](#community-and-support)
- [License](#license)

## Overview

This chart brings up a full Tinkerbell stack on a Kubernetes cluster using the Helm package manager.

These charts have been forked from the open source repo [github.com/tinkerbell/charts](https://github.com/tinkerbell/charts)
Summary of all the changes and contributions can be found [here](CHANGELOG.md)

The following components have been derived from the open source Tinkerbell stack:

- [Tink](https://github.com/tinkerbell/tink)
- NGINX server
- [Smee](https://github.com/tinkerbell/smee)
- [Hegel](https://github.com/tinkerbell/hegel)
- [Hook](https://github.com/tinkerbell/hook)
- kube-vip Loadbalancer

out of which only the following are enabled by default at present

- Tink
- NGINX server (named Provisioning Artifacts Server)

A switch named `traefikReverseProxy` is provided which determines whether to use ingress and ingressroutes provided by
EMF external to these chart configurations, or use the local routing using `kube-vip`.

If `traefikReverseProxy` is disabled:

- Enable `kube-vip` to provide a service type loadBalancer IP for the Tinkerbell stack services
- `stack` acts as a server for handling proxying to the Tinkerbell service and for serving the Hook artifacts

If `traefikReverseProxy` is enabled:

- Traefik service running in `orch-gateway` namespace provides `IngressRoute` to `tink-server`
- NGINX based `Ingress` running in `orch-infra` namespace provides route to `pa-server`

### Why Smee is not required?

All the functionalities of Smee are being handled by the following components:

- DHCP server (assigns IP addresses):
  - Local DHCP server is expected to run in Edge Node network.
- TFTP/HTTP server [ Generate and serve ipxe.efi/auto.ipxe] :
  - ipxe.efi generated by [DKAM](https://github.com/open-edge-platform/infra-onboarding/tree/main/dkam)
  - auto.ipxe is replaced by static boot.ipxe
  - Above mentioned files are hosted in PA server.
- Syslog server [ Listen and store the the Tink Worker Logs] :
  - Handled by telemetry service running in EMF

### Why Hook is not required?

Hook OS image download and cryptographic signing is managed by [DKAM](https://github.com/open-edge-platform/infra-onboarding/tree/main/dkam)

### Why Hegel is not required?

Post booting to provisioned OS, cloud-init configuration is handled by [Onboarding Manager](https://github.com/open-edge-platform/infra-onboarding/tree/main/onboarding-manager)

## Get Started

### Bringing up the Edge Orchestrator

See the [the Edge Orchestrator documentation](https://github.com/open-edge-platform/edge-manageability-framework/blob/main/README.md) to learn more about setting up the Edge Orchestrator.

## Installing the Chart

If Tinkerbell charts are not deployed already in [Infra-Onboarding Chart](../infra-onboarding/Chart.yaml):

1. Fill in all the required fields in [values.yaml](values.yaml). Details about the fields can be found within the file.
2. Run the following set of commands

```bash
git clone https://github.com/open-edge-platform/infra-charts
cd  infra-charts
helm dependency build tinkerbell/
helm install tinkerbell -f tinkerbell/values.yaml tinkerbell/ --create-namespace --namespace orch-infra --wait
```

These commands install the Tinkerbell Stack chart in the `orch-infra` namespace with the release name of `tinkerbell`.

## Validation steps

Copy the orch-CA certificate to your setup.

### For testing tink-stack

```bash
wget --no-proxy --ca-certificate=orch-ca.crt https://<nginxDnsname>/tink-stack/boot.ipxe
```

`nginxDnsname` is configured within [values.yaml](values.yaml).

### For testing tink-server

```bash
    apt update
    apt install curl
    apt install golang
    go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
    cd ~/go/bin
    ./grpcurl -cacert orch-ca.crt <tinkServerDnsname>:443 list
```

`tinkServerDnsname` is configured within [values.yaml](values.yaml).

## Installing the Chart with traefikReverseProxy disabled

Before installing the chart:

- Customize the IP used for the load balancer (`stack.loadBalancerIP`). This IP provides ingress for
Hegel, Tink, and Smee (TFTP, HTTP, and SYSLOG endpoints as well as unicast DHCP requests).

- If enabling smee, based on the services you want to use:
  - set the IP used in DHCP packets for option 54, the location of the iPXE binaries, the `auto.ipxe` script.
  - syslog IP, and the IP for downloading Hook files (`tinkerbell_smee.remoteIp`).
  The vast majority of the time,these 2 (`stack.loadBalancerIP` and `tinkerbell_smee.remoteIp`) IPs will be the same.

Now, deploy the chart.

```bash
git clone https://github.com/open-edge-platform/infra-charts
cd  infra-charts
helm dependency build tinkerbell/charts/tinkerbell
trusted_proxies=$(kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr ' ' ',')
helm install tinkerbell tinkerbell/charts/tinkerbell --create-namespace --namespace orch-infra --wait --set "tinkerbell_smee.trustedProxies=${trusted_proxies}" --set "tinkerbell_hegel.trustedProxies=${trusted_proxies}"
```

These commands install the Tinkerbell Stack chart in the `orch-infra` namespace with the release name of `tinkerbell`.

## Uninstalling the Chart

To uninstall/delete the `tinkerbell` deployment:

```bash
helm uninstall tinkerbell --namespace tink-system
```

## Parameters

### Stack Service Parameters

| Name | Description | Value |
| ---- | ----------- | ----- |
| `stack.enabled` | Enable the deployment of the Tinkerbell stack chart | `true` |
| `stack.name` | Name for the stack chart | `tink-stack` |
| `stack.service.type` | Type of service to use for the Tinkerbell stack services. One of the [standard](https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types) Kubernetes service types. (Applicable only with `traefikReverseProxy` disabled) | `LoadBalancer` |
| `stack.selector` | Selector(s) to use for the mapping stack deployment with the service | `app: tink-stack` |
| `stack.loadBalancerIP` | Load balancer IP address to use for the Tinkerbell stack services. (Applicable only for `traefikReverseProxy`) | `192.168.2.111` |
| `stack.lbClass` | loadBalancerClass to use for in stack service. (Applicable only for `traefikReverseProxy`)| `kube-vip.io/kube-vip-class` |
| `stack.image` | Image to use for the proxying to Tinkerbell services and serving artifacts | `nginxinc/nginx-unprivileged:alpine3.21` |
| `stack.hook.enabled` | Enable the deployment of the Hook artifacts | `false` |
| `stack.hook.name` | Name for the Hook artifacts server | `tinkerbell-hook-files` |
| `stack.hook.port` | Port to use for the Hook artifacts server | `8080` |
| `stack.hook.image` | Image to use for downloading the Hook artifacts | `alpine` |
| `stack.hook.downloads` | List of Hook artifacts to download | `[]` |
| `stack.hook.downloads[0].url` | URL of the Hook bundle to download | `""` |
| `stack.hook.downloads[0].sha512sum` | sha512sum of the Hook bundle | `""` |

### Load Balancer Parameters (kube-vip) (Applicable only for on-prem)

| Name | Description | Value |
| ---- | ----------- | ----- |
| `kubevip.enabled` | Enable the deployment of the kube-vip load balancer | `false` |
| `kubevip.name` | Name for the kube-vip load balancer service | `kube-vip` |
| `kubevip.image` | Image to use for the kube-vip load balancer | `ghcr.io/kube-vip/kube-vip:v0.5.0` |
| `kubevip.imagePullPolicy` | Image pull policy to use for kube-vip | `IfNotPresent` |
| `kubevip.roleName` | Role name to use for the kube-vip load service | `kube-vip-role` |
| `kubevip.roleBindingName` | Role binding name to use for the kube-vip load service | `kube-vip-rolebinding` |
| `kubevip.interface` | Interface to use for advertizing the load balancer IP. Leaving it unset to allow Kubevip to auto discover the interface to use. | `""` |

### Tinkerbell Services Parameters

All dependent services(Smee, Hegel, Rufio, Tink) can have their values overridden here.
The following format is used to accomplish this.

```yaml
<service name>:
  <key to override>: <value>
  <array key to override>:
    - <key>: <value>
```

Example:

```yaml
hegel:
  image: quay.io/tinkerbell/hegel:latest
```

### Smee Parameters

| Name | Description | Value |
| ---- | ----------- | ----- |
| `smee.hostNetwork` | Whether to deploy Smee using `hostNetwork` on the pod spec. When `true` Smee will be able to receive DHCP broadcast messages. If `false`, Smee will be behind the load balancer VIP and will need to receive DHCP requests via unicast. | `true` |

See the [documentation][user-guide-url] if you want to learn more about using Edge Orchestrator.

## Contribute

To learn how to contribute to the project, see the [contributor's guide][contributors-guide-url]. The project will
accept contributions through Pull-Requests (PRs). PRs must be built successfully by the CI pipeline, pass linters
verifications and the unit tests.

## Community and Support

To learn more about the project, its community, and governance, visit
the [Edge Orchestrator Community](https://community.intel.com/).

For support, start with [Troubleshooting][troubleshooting-url]

- For more information on how to onboard an edge node, refer to the [user guide on onboarding an edge node][user-guide-onboard-edge-node].
- To get started, check out the [user guide][user-guide-url].
- For the infrastructure manager development guide, visit the [infrastructure manager development guide][inframanager-dev-guide-url].

## License

Edge Orchestrator is licensed under [Apache License
2.0](http://www.apache.org/licenses/LICENSE-2.0).

[user-guide-onboard-edge-node]: https://docs.openedgeplatform.intel.com/edge-manage-docs/main/user_guide/set_up_edge_infra/index.html
[user-guide-url]: https://docs.openedgeplatform.intel.com/edge-manage-docs/main/user_guide/get_started_guide/index.html
[inframanager-dev-guide-url]: https://docs.openedgeplatform.intel.com/edge-manage-docs/main/developer_guide/infra_manager/index.html
[contributors-guide-url]: https://docs.openedgeplatform.intel.com/edge-manage-docs/main/developer_guide/contributor_guide/index.html
[troubleshooting-url]: https://docs.openedgeplatform.intel.com/edge-manage-docs/main/user_guide/troubleshooting/index.html

Last Updated Date: March 26, 2025
